<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analiza Polygons</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
  />
  <link rel="stylesheet" href="styles.css" />
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%232563eb'/%3E%3Cpath d='M26 50l18 18 30-36' stroke='%23fff' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"
  />
</head>
<body>
  <header class="hero">
    <div>
      <p class="eyebrow">Analiza Polygons <span class="version-tag">v1.28.0</span></p>
      <h1>Mapa real de OpenStreetMap listo para capturar coordenadas</h1>
      <p class="lead">
        Dibuja polígonos directamente sobre un mapa embebido y copia las coordenadas con el formato que prefieras.
      </p>
    </div>
  </header>

  <main class="content">
    <section class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Mapa base</p>
          <h2>Dibuja sobre OpenStreetMap</h2>
        </div>
        <form id="location-form" class="search-controls">
          <label class="field field--compact">
            <span>Buscar localidad</span>
            <div class="search-controls__inputs">
              <input
                id="location-input"
                name="location"
                type="search"
                placeholder="Ej. Madrid, España"
                autocomplete="off"
                aria-label="Buscar localidad en OpenStreetMap"
                required
              />
              <button id="location-search-btn" class="ghost emphasis" type="submit">Buscar</button>
            </div>
          </label>
        </form>
        <div class="import-controls">
          <input type="file" id="geojson-input" accept=".geojson,.json" hidden />
          <input type="file" id="shp-input" accept=".zip" hidden />
          <button id="select-shp-area-btn" class="ghost emphasis" type="button">Seleccionar área SHP</button>
          <button id="import-shp-limited-btn" class="primary" type="button">Cargar N polígonos SHP</button>
          <button id="import-shp-btn" class="primary" type="button">Cargar SHP</button>
          <button id="import-btn" class="ghost" type="button">Importar GeoJSON</button>
          <button id="import-shp-example-btn" class="ghost" type="button">Ejemplo SHP</button>
          <button id="import-example-btn" class="ghost" type="button">Cargar ejemplo</button>
        </div>
        <span id="map-status" class="status"></span>
      </div>
      <div class="map-layout">
        <div class="map-wrapper">
          <div id="map" aria-label="Mapa de dibujo"></div>
          <div class="visibility-toggles" aria-label="Alternar visibilidad de polígonos importados">
            <label class="toggle">
              <input id="toggle-original" type="checkbox" />
              <span>Mostrar polígonos originales (GeoJSON)</span>
            </label>
            <label class="toggle">
              <input id="toggle-simplified" type="checkbox" checked />
              <span>Mostrar polígonos simplificados</span>
            </label>
            <label class="toggle">
              <input id="toggle-names" type="checkbox" />
              <span>Mostrar nombres en el mapa</span>
            </label>
          </div>
          <div class="random-selection" aria-label="Selección aleatoria de polígonos importados">
            <label class="field">
              <span>Quedarme con N polígonos aleatorios</span>
              <div class="random-selection__controls">
                <input id="random-count" type="number" min="1" step="1" placeholder="Ej. 10" />
                <button id="random-apply-btn" class="ghost" type="button">Aplicar selección</button>
              </div>
            </label>
            <p class="helper helper--compact">
              Se aplica sobre polígonos importados (SHP/GeoJSON) y descarta el resto.
            </p>
          </div>
          <div class="helper">
            <p><strong>Cómo usarlo</strong></p>
            <ol>
              <li>Selecciona la herramienta de polígono y haz clic en el mapa para definir cada vértice.</li>
              <li>El panel inferior lista cada polígono numerado con sus coordenadas.</li>
              <li>Copia el resultado y pégalo en tu flujo de trabajo.</li>
            </ol>
          </div>
        </div>
        <aside class="export-sidebar" aria-label="Exportaciones rápidas">
          <p class="eyebrow">Exportaciones</p>
          <h3>Polígonos simplificados</h3>
          <div class="export-column">
            <button id="export-geojson-simplified-btn" class="primary">Descargar GeoJSON simplificado</button>
            <button id="copy-btn" class="ghost">Copiar simplificado</button>
            <button id="copy-qlik-simplified-btn" class="ghost emphasis">Qlik simplificado</button>
            <button id="copy-if-simplified-btn" class="ghost">IF simplificado</button>
            <button id="copy-pick-simplified-btn" class="ghost">PickMatch simplificado</button>
            <button id="copy-gestiona-simplified-btn" class="ghost">Gestiona simplificado</button>
            <button id="copy-csv-simplified-btn" class="ghost">CSV simplificado</button>
          </div>
          <h3>Polígonos completos</h3>
          <div class="export-column">
            <button id="export-geojson-complete-btn" class="primary">Descargar GeoJSON completo</button>
            <button id="copy-complete-btn" class="ghost">Copiar completo</button>
            <button id="copy-qlik-complete-btn" class="ghost">Qlik completo</button>
            <button id="copy-if-complete-btn" class="ghost">IF completo</button>
            <button id="copy-pick-complete-btn" class="ghost">PickMatch completo</button>
            <button id="copy-gestiona-complete-btn" class="ghost">Gestiona completo</button>
            <button id="copy-csv-complete-btn" class="ghost">CSV completo</button>
          </div>
          <button id="reset-btn" class="ghost">Limpiar mapa</button>
          <span id="copy-status" class="status"></span>
        </aside>
      </div>
    </section>

    <section class="panel log-visual">
      <header class="panel-header">
        <div>
          <p class="eyebrow">Registro</p>
          <h2>Pasos de importación</h2>
        </div>
      </header>
      <div id="visual-log" class="log-entries" aria-live="polite">
        <div class="log-entry info">Listo para registrar los pasos de importación.</div>
      </div>
    </section>

    <section class="panel">
      <header class="panel-header">
        <div>
          <p class="eyebrow">Exportación</p>
          <h2>Coordenadas generadas</h2>
        </div>
      </header>
      <pre id="output" aria-live="polite" class="output">Crea al menos un polígono para ver sus coordenadas aquí.</pre>
      <div class="if-preview">
        <p><strong>Vista previa IF</strong></p>
        <pre id="if-preview" aria-live="polite" class="output soft">Genera una expresión IF desde el modal para verla aquí.</pre>
      </div>
      <div class="if-preview">
        <p><strong>Vista previa PickMatch</strong></p>
        <pre id="pick-preview" aria-live="polite" class="output soft">Genera una expresión PickMatch desde el modal para verla aquí.</pre>
      </div>
    </section>
  </main>

    <div id="if-modal" class="if-modal" role="dialog" aria-modal="true" aria-labelledby="if-modal-title" aria-hidden="true">
      <div class="if-modal__content">
        <header class="if-modal__header">
          <div>
            <p class="eyebrow">Exportar IF</p>
          <h3 id="if-modal-title">Configura la expresión IF para Qlik</h3>
        </div>
        <button id="if-modal-close" class="icon-btn" aria-label="Cerrar modal">×</button>
      </header>
      <form id="if-form" class="if-form">
        <label class="field field--inline">
          <span>¿Usar valores de nombre de los polígonos?</span>
          <input id="use-polygon-names" name="usePolygonNames" type="checkbox" />
        </label>
        <label class="field">
          <span>Nombre del tesauro</span>
          <input id="thesaurus-name" name="thesaurus" type="text" placeholder="Ej. campo_municipio" required />
        </label>
        <div id="polygon-values" class="polygon-values" aria-live="polite"></div>
        <p id="polygon-values-helper" class="helper helper--compact">
          Activa los valores manuales si prefieres elegir un tesauro diferente para cada polígono.
        </p>
        <div class="if-form__actions">
          <button type="button" id="if-cancel" class="ghost">Cancelar</button>
          <button type="submit" class="primary">Generar y copiar IF</button>
        </div>
      </form>
    </div>
  </div>

  <div id="pick-modal" class="if-modal" role="dialog" aria-modal="true" aria-labelledby="pick-modal-title" aria-hidden="true">
    <div class="if-modal__content">
      <header class="if-modal__header">
        <div>
          <p class="eyebrow">Exportar PickMatch</p>
          <h3 id="pick-modal-title">Configura la expresión PickMatch para Qlik</h3>
        </div>
        <button id="pick-modal-close" class="icon-btn" aria-label="Cerrar modal">×</button>
      </header>
      <form id="pick-form" class="if-form">
        <label class="field field--inline">
          <span>¿Usar valores de nombre de los polígonos?</span>
          <input id="use-pick-names" name="usePickNames" type="checkbox" />
        </label>
        <label class="field">
          <span>Campo de referencia para Match</span>
          <input id="pick-reference" name="pickReference" type="text" placeholder="Ej. ReferenciaCampo" required />
        </label>
        <div id="pick-values" class="polygon-values" aria-live="polite"></div>
        <p id="pick-values-helper" class="helper helper--compact">
          Activa los valores manuales si prefieres elegir un valor diferente para cada polígono.
        </p>
        <div class="if-form__actions">
          <button type="button" id="pick-cancel" class="ghost">Cancelar</button>
          <button type="submit" class="primary">Generar y copiar PickMatch</button>
        </div>
      </form>
    </div>
  </div>

  <div
    id="shp-selection-modal"
    class="if-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="shp-selection-title"
    aria-hidden="true"
  >
    <div class="if-modal__content">
      <header class="if-modal__header">
        <div>
          <p class="eyebrow">Carga SHP por área</p>
          <h3 id="shp-selection-title">Define cuántos polígonos cargar</h3>
        </div>
        <button id="shp-selection-close" class="icon-btn" aria-label="Cerrar modal">×</button>
      </header>
      <form id="shp-selection-form" class="if-form">
        <label class="field">
          <span>Número de polígonos a cargar</span>
          <input
            id="shp-selection-count"
            name="shpSelectionCount"
            type="number"
            min="1"
            step="1"
            placeholder="Ej. 25"
            required
          />
        </label>
        <p id="shp-selection-helper" class="helper helper--compact">
          Dibuja primero un área con "Seleccionar área SHP" para filtrar los polígonos.
        </p>
        <div class="if-form__actions">
          <button type="button" id="shp-selection-cancel" class="ghost">Cancelar</button>
          <button type="submit" id="shp-selection-pick-btn" class="primary">Seleccionar SHP</button>
        </div>
      </form>
    </div>
  </div>

  <div
    id="gestiona-modal"
    class="if-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="gestiona-modal-title"
    aria-hidden="true"
  >
    <div class="if-modal__content">
      <header class="if-modal__header">
        <div>
          <p class="eyebrow">Exportar Gestiona</p>
          <h3 id="gestiona-modal-title">Configura el código Gestiona</h3>
        </div>
        <button id="gestiona-modal-close" class="icon-btn" aria-label="Cerrar modal">×</button>
      </header>
      <form id="gestiona-form" class="if-form">
        <label class="field field--inline">
          <span>¿Usar nombres de polígonos como referencia?</span>
          <input id="use-gestiona-names" name="useGestionaNames" type="checkbox" />
        </label>
        <label class="field">
          <span>Referencia (campo de valores)</span>
          <input
            id="gestiona-reference"
            name="gestionaReference"
            type="text"
            placeholder="Ej. Referencia"
            required
          />
        </label>
        <label class="field">
          <span>Referencia campo coordenadas</span>
          <input
            id="gestiona-coords"
            name="gestionaCoords"
            type="text"
            placeholder="Ej. ReferenciaCampoCoordenadas"
            required
          />
        </label>
        <div id="gestiona-values" class="polygon-values" aria-live="polite"></div>
        <p id="gestiona-values-helper" class="helper helper--compact">
          Activa los valores manuales si quieres definir un valor de referencia distinto por polígono.
        </p>
        <div class="if-form__actions">
          <button type="button" id="gestiona-cancel" class="ghost">Cancelar</button>
          <button type="submit" class="primary">Generar y copiar Gestiona</button>
        </div>
      </form>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%232563eb'/%3E%3Cpath d='M26 50l18 18 30-36' stroke='%23fff' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"
  />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
  <script src="main.js"></script>
</body>
</html>
